from app.models import ScanJob, Vulnerability, Asset, VulnStatus, db
import uuid
from datetime import datetime
from typing import Dict, List, Any

def create_cve_vulnerability_records(job: ScanJob, results: Dict):
    """Create vulnerability records from CVE analysis results"""
    asset = get_or_create_asset(job.target)
    
    for service_result in results.get('results', []):
        for vuln in service_result['vulnerabilities']:
            create_vulnerability_record(job, asset, vuln, 'cve_analysis')

def create_web_vulnerability_records(job: ScanJob, results: Dict):
    """Create vulnerability records from web security findings"""
    asset = get_or_create_asset(job.target)
    
    for vuln in results.get('vulnerabilities', []):
        create_vulnerability_record(job, asset, vuln, 'web_security')

def create_ssl_vulnerability_records(job: ScanJob, results: Dict):
    """Create vulnerability records from SSL security findings"""
    asset = get_or_create_asset(job.target)
    
    for vuln in results.get('vulnerabilities', []):
        create_vulnerability_record(job, asset, vuln, 'ssl_security')

def create_credential_vulnerability_records(job: ScanJob, results: Dict):
    """Create vulnerability records from credential testing results"""
    asset = get_or_create_asset(job.target)
    
    for cred in results.get('vulnerable_credentials', []):
        vulnerability_data = {
            'type': 'WEAK_CREDENTIALS',
            'severity': cred.get('severity', 'MEDIUM'),
            'description': f'Weak or default credentials for {cred.get("service", "unknown")} service',
            'recommendation': 'Change default credentials and implement strong authentication policies',
            'evidence': f'Username: {cred.get("username", "unknown")}, Service: {cred.get("service", "unknown")}',
            'port': results.get('port'),
            'protocol': 'tcp'
        }
        create_vulnerability_record(job, asset, vulnerability_data, 'credential_testing')

def create_vulnerability_records(job: ScanJob, results: Dict):
    """Create vulnerability records from comprehensive assessment results"""
    asset = get_or_create_asset(job.target)
    
    # Process web security vulnerabilities
    if results.get('web_security'):
        for vuln in results['web_security']['vulnerabilities']:
            create_vulnerability_record(job, asset, vuln, 'web_security')
    
    # Process SSL vulnerabilities
    if results.get('ssl_security'):
        for vuln in results['ssl_security']['vulnerabilities']:
            create_vulnerability_record(job, asset, vuln, 'ssl_security')
    
    # Process CVE vulnerabilities
    if results.get('cve_analysis'):
        for service_result in results['cve_analysis']['results']:
            for vuln in service_result['vulnerabilities']:
                create_vulnerability_record(job, asset, vuln, 'cve_analysis')
    
    # Process credential testing results
    if results.get('credential_testing'):
        create_credential_vulnerability_records(job, results['credential_testing'])

def create_vulnerability_record(job: ScanJob, asset: Asset, vuln_data: Dict, source: str):
    """Create a single vulnerability record"""
    try:
        # Calculate CVSS score if not provided
        cvss_score = vuln_data.get('cvss_score')
        if cvss_score is None:
            cvss_score = calculate_cvss_from_severity(vuln_data.get('severity', 'LOW'))
        
        vulnerability = Vulnerability(
            id=uuid.uuid4(),
            asset_id=asset.id,
            scan_job_id=job.id,
            cve_id=vuln_data.get('cve_id'),
            title=vuln_data.get('type', 'Unknown Vulnerability'),
            description=vuln_data.get('description', ''),
            severity=vuln_data.get('severity', 'LOW'),
            cvss_score=cvss_score,
            port=vuln_data.get('port'),
            protocol=vuln_data.get('protocol', 'tcp'),
            proof={
                'evidence': vuln_data.get('evidence'),
                'source': source,
                'timestamp': datetime.utcnow().isoformat(),
                'raw_data': vuln_data
            },
            status=VulnStatus.OPEN,
            discovered_at=datetime.utcnow()
        )
        
        db.session.add(vulnerability)
        db.session.commit()
        
    except Exception as e:
        db.session.rollback()
        print(f"Failed to create vulnerability record: {e}")

def get_or_create_asset(target: str) -> Asset:
    """Get or create an asset record for the target"""
    try:
        # Extract hostname from target
        if '://' in target:
            hostname = target.split('://')[-1].split('/')[0].split(':')[0]
        else:
            hostname = target.split('/')[0].split(':')[0]
        
        # Try to find existing asset
        asset = Asset.query.filter(
            (Asset.hostname == hostname) | (Asset.ip_address == hostname)
        ).first()
        
        if not asset:
            asset = Asset(
                id=uuid.uuid4(),
                ip_address=hostname,  # In production, you might want to resolve this
                hostname=hostname,
                domain=hostname,
                risk_score=0,
                first_seen=datetime.utcnow(),
                last_seen=datetime.utcnow()
            )
            db.session.add(asset)
            db.session.commit()
        
        return asset
        
    except Exception as e:
        db.session.rollback()
        # Create a minimal asset if lookup fails
        asset = Asset(
            id=uuid.uuid4(),
            ip_address=target,
            hostname=target,
            domain=target,
            risk_score=0
        )
        db.session.add(asset)
        db.session.commit()
        return asset

def calculate_cvss_from_severity(severity: str) -> float:
    """Calculate approximate CVSS score from severity"""
    severity_scores = {
        'CRITICAL': 9.0,
        'HIGH': 7.5,
        'MEDIUM': 5.0,
        'LOW': 2.0
    }
    return severity_scores.get(severity.upper(), 2.0)