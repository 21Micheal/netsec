from typing import Dict, List, Any
from app.models import ScanJob, Vulnerability, Asset, VulnStatus, db
import uuid
from datetime import datetime

def generate_cve_insights(results: Dict) -> Dict:
    """Generate insights from CVE analysis results"""
    insights = {
        'key_findings': [],
        'recommendations': [],
        'risk_summary': {}
    }
    
    cve_results = results.get('results', [])
    summary = results.get('summary', {})
    
    # Key findings
    if summary.get('vulnerable_services', 0) > 0:
        insights['key_findings'].append(
            f"{summary['vulnerable_services']} services have known vulnerabilities"
        )
    
    if summary.get('total_vulnerabilities', 0) > 0:
        insights['key_findings'].append(
            f"Total of {summary['total_vulnerabilities']} CVE vulnerabilities identified"
        )
    
    # Service-specific findings
    vulnerable_services = []
    for result in cve_results:
        if result['vulnerabilities']:
            service = result['service']
            service_name = f"{service['name']} {service['version']}" if service['version'] else service['name']
            vulnerable_services.append(service_name)
    
    if vulnerable_services:
        insights['key_findings'].append(
            f"Vulnerable services: {', '.join(vulnerable_services)}"
        )
    
    # Recommendations
    if summary.get('total_vulnerabilities', 0) > 0:
        insights['recommendations'].append('Apply security patches for identified CVEs')
        insights['recommendations'].append('Update vulnerable software to latest versions')
        insights['recommendations'].append('Implement network segmentation for vulnerable services')
    
    insights['risk_summary'] = summary
    
    return insights

def generate_ssl_insights(results: Dict) -> Dict:
    """Generate insights from SSL security findings"""
    insights = {
        'key_findings': [],
        'recommendations': []
    }
    
    vulns = results.get('vulnerabilities', [])
    cert_info = results.get('certificate_info', {})
    protocol_info = results.get('protocol_info', {})
    security_score = results.get('security_score', 100)
    
    # Certificate insights - SAFELY handle missing fields
    has_expired = cert_info.get('has_expired', False)
    days_until_expiry = cert_info.get('days_until_expiry', 0)
    
    if has_expired:
        insights['key_findings'].append('SSL certificate has expired - immediate renewal required')
    elif days_until_expiry < 30 and days_until_expiry > 0:
        insights['key_findings'].append(
            f"SSL certificate expires in {days_until_expiry} days"
        )
    
    # Protocol insights
    if protocol_info.get('weak_protocols_enabled', False):
        insights['key_findings'].append('Weak SSL/TLS protocols (SSLv2, SSLv3, TLS 1.0, TLS 1.1) are enabled')
    
    # Vulnerability insights
    critical_ssl_vulns = [v for v in vulns if v.get('severity') in ['CRITICAL', 'HIGH']]
    if critical_ssl_vulns:
        insights['key_findings'].append(
            f"{len(critical_ssl_vulns)} critical SSL/TLS vulnerabilities found"
        )
    
    # Score-based insights
    if security_score < 50:
        insights['key_findings'].append('SSL/TLS configuration is critically weak')
    elif security_score < 70:
        insights['key_findings'].append('SSL/TLS configuration needs significant improvement')
    
    # Recommendations
    insights['recommendations'].append('Disable SSLv2, SSLv3, TLS 1.0, and TLS 1.1')
    insights['recommendations'].append('Use TLS 1.2 or higher with strong cipher suites')
    
    if days_until_expiry < 60:
        insights['recommendations'].append('Renew SSL certificate before expiration')
    
    if any('WEAK_CIPHER' in vuln.get('type', '') for vuln in vulns):
        insights['recommendations'].append('Remove weak cipher suites from configuration')
    
    insights['risk_summary'] = {
        'security_score': security_score,
        'critical_vulnerabilities': len(critical_ssl_vulns),
        'certificate_status': 'expired' if has_expired else 'valid' if cert_info else 'unknown'
    }
    
    return insights

def generate_web_security_insights(web_results: Dict) -> Dict:
    """Generate insights for web security findings"""
    insights = {
        'key_findings': [],
        'recommendations': []
    }
    
    vulns = web_results.get('vulnerabilities', [])
    risk_assessment = web_results.get('risk_assessment', {})
    
    # Key findings based on risk assessment
    if risk_assessment.get('critical_count', 0) > 0:
        insights['key_findings'].append('Critical security vulnerabilities detected requiring immediate attention')
    
    if risk_assessment.get('high_count', 0) > 0:
        insights['key_findings'].append('High severity vulnerabilities need prompt remediation')
    
    # Count vulnerability types
    vuln_types = {}
    for vuln in vulns:
        vuln_type = vuln.get('type', 'UNKNOWN')
        vuln_types[vuln_type] = vuln_types.get(vuln_type, 0) + 1
    
    # Add specific findings for common vulnerability types
    for vuln_type, count in vuln_types.items():
        if count > 0 and any(keyword in vuln_type for keyword in ['MISSING_SECURITY_HEADER', 'SSL', 'CVE', 'SENSITIVE_PATH']):
            insights['key_findings'].append(f'{count} {vuln_type.replace("_", " ").lower()} issues found')
    
    # Recommendations based on findings
    if any('MISSING_SECURITY_HEADER' in vuln.get('type', '') for vuln in vulns):
        insights['recommendations'].append('Implement missing security headers (CSP, HSTS, X-Frame-Options, etc.)')
    
    if any('SSL' in vuln.get('type', '') for vuln in vulns):
        insights['recommendations'].append('Upgrade SSL/TLS configuration to use stronger protocols and ciphers')
    
    if any('SENSITIVE_PATH' in vuln.get('type', '') for vuln in vulns):
        insights['recommendations'].append('Restrict access to sensitive directories and files')
    
    if any('CVE' in vuln.get('type', '') for vuln in vulns):
        insights['recommendations'].append('Apply security patches for known vulnerabilities')
    
    # General security recommendations
    insights['recommendations'].append('Implement regular security scanning and monitoring')
    insights['recommendations'].append('Follow web application security best practices (OWASP)')
    
    insights['risk_summary'] = risk_assessment
    
    return insights

def generate_credential_insights(results: Dict) -> Dict:
    """Generate insights from credential testing results"""
    insights = {
        'key_findings': [],
        'recommendations': results.get('recommendations', [])
    }
    
    service = results.get('service', '')
    vulnerable_creds = results.get('vulnerable_credentials', [])
    
    if vulnerable_creds:
        insights['key_findings'].append(
            f"{len(vulnerable_creds)} vulnerable credentials found for {service}"
        )
    else:
        insights['key_findings'].append(f"Credential testing completed for {service} service")
    
    # Add service-specific recommendations
    if service in ['ssh', 'ftp', 'telnet']:
        insights['recommendations'].append(f'Implement key-based authentication for {service}')
        insights['recommendations'].append(f'Use fail2ban or similar tools to protect {service}')
    
    return insights

def generate_vulnerability_insights(results: Dict) -> Dict:
    """Generate overall insights from vulnerability assessment results"""
    insights = {
        'key_findings': [],
        'recommendations': [],
        'risk_summary': {},
        'component_analysis': {}
    }
    
    # Add insights from each component
    if results.get('web_security'):
        web_insights = generate_web_security_insights(results['web_security'])
        insights['key_findings'].extend(web_insights.get('key_findings', []))
        insights['recommendations'].extend(web_insights.get('recommendations', []))
        insights['component_analysis']['web_security'] = web_insights.get('risk_summary', {})
    
    if results.get('ssl_security'):
        ssl_insights = generate_ssl_insights(results['ssl_security'])
        insights['key_findings'].extend(ssl_insights.get('key_findings', []))
        insights['recommendations'].extend(ssl_insights.get('recommendations', []))
        insights['component_analysis']['ssl_security'] = ssl_insights.get('risk_summary', {})
    
    if results.get('cve_analysis'):
        cve_insights = generate_cve_insights(results['cve_analysis'])
        insights['key_findings'].extend(cve_insights.get('key_findings', []))
        insights['recommendations'].extend(cve_insights.get('recommendations', []))
        insights['component_analysis']['cve_analysis'] = cve_insights.get('risk_summary', {})
    
    if results.get('credential_testing'):
        cred_insights = generate_credential_insights(results['credential_testing'])
        insights['key_findings'].extend(cred_insights.get('key_findings', []))
        insights['recommendations'].extend(cred_insights.get('recommendations', []))
    
    if results.get('overall_risk'):
        insights['risk_summary'] = results['overall_risk']
    
    # Remove duplicates
    insights['key_findings'] = list(set(insights['key_findings']))
    insights['recommendations'] = list(set(insights['recommendations']))
    
    return insights