import React, { useState, useEffect, useCallback } from 'react';
import VulnerabilityApi, { VulnerabilityScanRequest } from '../../services/vulnerabilityApi';
import { ScanJob, Vulnerability, DashboardStats } from '../../types/vulnerability';
import NewScanModal from '../../pages/NewScanModal';
import ScanResults from '../vulnerability/ScanResults';
import VulnerabilityList from './VulnerabilityList';
import { VulnerabilityDetails } from './VulnerabilityDetails';
import RiskMeter from './RiskMeter';

const VulnerabilityDashboard: React.FC = () => {
  const [activeScans, setActiveScans] = useState<ScanJob[]>([]);
  const [recentScans, setRecentScans] = useState<ScanJob[]>([]);
  const [recentFindings, setRecentFindings] = useState<Vulnerability[]>([]);
  const [stats, setStats] = useState<DashboardStats | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [selectedScan, setSelectedScan] = useState<ScanJob | null>(null);
  const [viewMode, setViewMode] = useState<'overview' | 'findings' | 'scan-details'>('overview');

  // Memoized data loading
  const loadDashboardData = useCallback(async () => {
    try {
      setIsLoading(true);
      setError(null);

      const [scansResponse, findingsResponse, statsResponse] = await Promise.all([
        VulnerabilityApi.getScans(1, 10),
        VulnerabilityApi.getVulnerabilities(1, 15, 'CRITICAL'),
        VulnerabilityApi.getVulnerabilityStats()
      ]);

      // Process data
      const scans = Array.isArray(scansResponse.scans) ? scansResponse.scans : [];
      const activeScansData = scans.filter(scan => 
        scan?.status === 'running' || scan?.status === 'queued'
      );
      const recentScansData = scans
        .filter(scan => scan?.status === 'finished')
        .slice(0, 5);

      const recentFindingsData = Array.isArray(findingsResponse.vulnerabilities) 
        ? findingsResponse.vulnerabilities 
        : [];

      // Calculate comprehensive stats
      const severityDistribution = statsResponse.severity_distribution || {};
      const totalVulnerabilities = Object.values(severityDistribution).reduce(
        (sum: number, value: unknown) => sum + (typeof value === 'number' ? value : 0), 
        0
      );
      const criticalAlerts = severityDistribution.CRITICAL || 0;

      setActiveScans(activeScansData);
      setRecentScans(recentScansData);
      setRecentFindings(recentFindingsData);
      
      setStats({
        activeScans: activeScansData.length,
        completedJobs: scans.filter(s => s.status === 'finished').length,
        systemLoad: Math.min(100, activeScansData.length * 25),
        alerts: criticalAlerts,
        totalScans: scansResponse.total || scans.length,
        successRate: scans.length > 0 ? 
          Math.round((scans.filter(s => s.status === 'finished').length / scans.length) * 100) : 0
      });
      
    } catch (error) {
      console.error('Failed to load dashboard data:', error);
      setError('Failed to load dashboard data. Please check your connection and try again.');
    } finally {
      setIsLoading(false);
    }
  }, []);

  // Auto-refresh when scans are active
  useEffect(() => {
    loadDashboardData();
    
    const interval = setInterval(() => {
      if (activeScans.length > 0) {
        loadDashboardData();
      }
    }, 5000);
    
    return () => clearInterval(interval);
  }, [loadDashboardData, activeScans.length]);

  const startNewScan = async (config: VulnerabilityScanRequest) => {
    try {
      await VulnerabilityApi.startScan(config);
      loadDashboardData();
    } catch (error) {
      console.error('Failed to start scan:', error);
      setError('Failed to start vulnerability scan. Please try again.');
    }
  };

  const showNewScanModal = () => {
    const modal = document.getElementById('new_scan_modal');
    if (modal instanceof HTMLDialogElement) {
      modal.showModal();
    }
  };

  const viewScanDetails = (scan: ScanJob) => {
    setSelectedScan(scan);
    setViewMode('scan-details');
  };

  const refreshData = () => {
    loadDashboardData();
  };

  if (isLoading) {
    return (
      <div className="flex flex-col items-center justify-center h-96 space-y-4">
        <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-primary"></div>
        <div className="text-center">
          <div className="text-lg font-semibold">Loading Vulnerability Data</div>
          <div className="text-sm text-gray-500">Scanning systems and analyzing results...</div>
        </div>
      </div>
    );
  }

  if (viewMode === 'scan-details' && selectedScan) {
    return (
      <div className="p-6">
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center space-x-4">
            <button 
              onClick={() => setViewMode('overview')}
              className="btn btn-ghost btn-sm"
            >
              ← Back to Dashboard
            </button>
            <h1 className="text-2xl font-bold">Scan Details</h1>
          </div>
          <button 
            onClick={refreshData}
            className="btn btn-ghost btn-sm"
            disabled={isLoading}
          >
            {isLoading ? 'Refreshing...' : 'Refresh'}
          </button>
        </div>
        <ScanResults scan={selectedScan} />
      </div>
    );
  }

  if (viewMode === 'findings') {
    return (
      <div className="p-6">
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center space-x-4">
            <button 
              onClick={() => setViewMode('overview')}
              className="btn btn-ghost btn-sm"
            >
              ← Back to Dashboard
            </button>
            <h1 className="text-2xl font-bold">All Vulnerability Findings</h1>
          </div>
          <div className="flex space-x-2">
            <button 
              onClick={refreshData}
              className="btn btn-ghost btn-sm"
              disabled={isLoading}
            >
              {isLoading ? 'Refreshing...' : 'Refresh'}
            </button>
            <button 
              onClick={showNewScanModal}
              className="btn btn-primary btn-sm"
            >
              New Scan
            </button>
          </div>
        </div>
        <VulnerabilityList />
      </div>
    );
  }

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Vulnerability Assessment</h1>
          <p className="text-gray-600">Monitor and analyze security vulnerabilities across your infrastructure</p>
        </div>
        <div className="flex space-x-2">
          <button 
            onClick={refreshData}
            className="btn btn-ghost"
            disabled={isLoading}
          >
            {isLoading ? (
              <>
                <span className="loading loading-spinner loading-sm"></span>
                Refreshing
              </>
            ) : (
              'Refresh Data'
            )}
          </button>
          <button 
            onClick={showNewScanModal}
            className="btn btn-primary"
          >
            <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            New Scan
          </button>
        </div>
      </div>

      {error && (
        <div className="alert alert-error shadow-lg">
          <svg xmlns="http://www.w3.org/2000/svg" className="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>{error}</span>
          <button className="btn btn-sm btn-ghost" onClick={() => setError(null)}>Dismiss</button>
        </div>
      )}

      {/* Risk Overview */}
      {stats && <RiskMeter stats={stats} recentFindings={recentFindings} />}

      {/* Main Dashboard Grid */}
      <div className="grid grid-cols-1 xl:grid-cols-3 gap-6">
        {/* Active Scans & Recent Results */}
        <div className="xl:col-span-2 space-y-6">
          {/* Active Scans */}
          <div className="card bg-base-100 shadow-lg">
            <div className="card-body">
              <div className="flex justify-between items-center mb-4">
                <h2 className="card-title">
                  Active Scans
                  {activeScans.length > 0 && (
                    <div className="badge badge-primary badge-lg ml-2">
                      {activeScans.length}
                    </div>
                  )}
                </h2>
                <div className="text-sm text-gray-500">
                  Auto-refresh: {activeScans.length > 0 ? 'On' : 'Off'}
                </div>
              </div>
              
              {activeScans.length === 0 ? (
                <div className="text-center py-8">
                  <div className="w-16 h-16 mx-auto mb-4 text-gray-400">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                  </div>
                  <p className="text-gray-500 mb-2">No active scans running</p>
                  <button 
                    className="btn btn-primary btn-sm"
                    onClick={showNewScanModal}
                  >
                    Start Your First Scan
                  </button>
                </div>
              ) : (
                <div className="space-y-3">
                  {activeScans.map(scan => (
                    <div key={scan.id} className="flex items-center justify-between p-4 bg-base-200 rounded-lg hover:bg-base-300 transition-colors">
                      <div className="flex items-center space-x-4 flex-1">
                        <div className={`w-3 h-3 rounded-full ${
                          scan.status === 'running' ? 'bg-green-500 animate-pulse' : 'bg-yellow-500'
                        }`}></div>
                        <div className="flex-1">
                          <div className="font-semibold text-sm truncate">{scan.target}</div>
                          <div className="text-xs text-gray-500 capitalize">
                            {scan.scan_type?.replace(/_/g, ' ')} • Started {new Date(scan.created_at).toLocaleTimeString()}
                          </div>
                        </div>
                      </div>
                      <div className="flex items-center space-x-4">
                        <div className="text-right">
                          <div className={`badge ${
                            scan.status === 'running' ? 'badge-primary' : 'badge-secondary'
                          }`}>
                            {scan.status}
                          </div>
                          <div className="text-xs text-gray-500 mt-1">{scan.progress}% complete</div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>

          {/* Recent Scan Results */}
          <div className="card bg-base-100 shadow-lg">
            <div className="card-body">
              <div className="flex justify-between items-center mb-4">
                <h2 className="card-title">Recent Scan Results</h2>
                <button 
                  onClick={() => setViewMode('findings')}
                  className="btn btn-ghost btn-sm"
                >
                  View All →
                </button>
              </div>
              
              {recentScans.length === 0 ? (
                <div className="text-center py-8">
                  <div className="w-16 h-16 mx-auto mb-4 text-gray-400">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  </div>
                  <p className="text-gray-500">No completed scans yet</p>
                </div>
              ) : (
                <div className="space-y-4">
                  {recentScans.slice(0, 3).map(scan => (
                    <div 
                      key={scan.id} 
                      className="p-4 bg-base-200 rounded-lg hover:bg-base-300 transition-colors cursor-pointer"
                      onClick={() => viewScanDetails(scan)}
                    >
                      <div className="flex justify-between items-start mb-2">
                        <div className="flex-1">
                          <div className="font-semibold text-sm truncate">{scan.target}</div>
                          <div className="text-xs text-gray-500">
                            {scan.scan_type?.replace(/_/g, ' ')} • {new Date(scan.finished_at!).toLocaleString()}
                          </div>
                        </div>
                        {scan.vulnerability_results?.overall_risk && (
                          <RiskBadge risk={scan.vulnerability_results.overall_risk} />
                        )}
                      </div>
                      
                      {scan.vulnerability_results && (
                        <div className="flex flex-wrap gap-2 mt-3">
                          <VulnerabilityCounts results={scan.vulnerability_results} />
                        </div>
                      )}
                      
                      <div className="text-xs text-primary mt-2 flex items-center">
                        Click to view detailed results →
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>

        {/* Sidebar - Critical Findings & Quick Stats */}
        <div className="space-y-6">
          {/* Critical Findings */}
          <div className="card bg-base-100 shadow-lg">
            <div className="card-body">
              <h2 className="card-title text-error">
                Critical Findings
                {recentFindings.length > 0 && (
                  <div className="badge badge-error badge-lg ml-2">
                    {recentFindings.length}
                  </div>
                )}
              </h2>
              
              {recentFindings.length === 0 ? (
                <div className="text-center py-4">
                  <div className="w-12 h-12 mx-auto mb-2 text-green-500">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  </div>
                  <p className="text-green-600 font-medium">No critical findings</p>
                  <p className="text-xs text-gray-500 mt-1">All systems are secure</p>
                </div>
              ) : (
                <div className="space-y-3 max-h-96 overflow-y-auto">
                  {recentFindings.map(finding => (
                    <div key={finding.id} className="p-3 bg-error bg-opacity-10 rounded-lg border border-error border-opacity-20">
                      <div className="flex justify-between items-start mb-1">
                        <div className="font-semibold text-sm line-clamp-2 flex-1">{finding.title}</div>
                        <span className="badge badge-error badge-sm ml-2">CRITICAL</span>
                      </div>
                      <p className="text-xs text-gray-600 line-clamp-2 mb-2">{finding.description}</p>
                      <div className="flex justify-between items-center text-xs">
                        <span className="text-gray-500">Found {new Date(finding.discovered_at).toLocaleDateString()}</span>
                        {finding.cvss_score && (
                          <span className="font-mono">CVSS: {finding.cvss_score}</span>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>

          {/* Quick Actions */}
          <div className="card bg-base-100 shadow-lg">
            <div className="card-body">
              <h2 className="card-title">Quick Actions</h2>
              <div className="space-y-2">
                <button 
                  onClick={showNewScanModal}
                  className="btn btn-primary btn-block justify-start"
                >
                  <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                  </svg>
                  New Vulnerability Scan
                </button>
                <button 
                  onClick={() => setViewMode('findings')}
                  className="btn btn-outline btn-block justify-start"
                >
                  <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  View All Findings
                </button>
                <button className="btn btn-outline btn-block justify-start">
                  <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  Generate Report
                </button>
              </div>
            </div>
          </div>

          {/* System Status */}
          {stats && (
            <div className="card bg-base-100 shadow-lg">
              <div className="card-body">
                <h2 className="card-title">System Status</h2>
                <div className="space-y-3">
                  <div className="flex justify-between items-center">
                    <span className="text-sm">Scanner Load</span>
                    <div className="flex items-center space-x-2">
                      <div className="w-16 bg-gray-200 rounded-full h-2">
                        <div 
                          className="bg-green-500 h-2 rounded-full transition-all" 
                          style={{ width: `${stats.systemLoad}%` }}
                        ></div>
                      </div>
                      <span className="text-xs font-mono">{stats.systemLoad}%</span>
                    </div>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-sm">Success Rate</span>
                    <span className="text-xs font-mono bg-success bg-opacity-20 text-success px-2 py-1 rounded">
                      {stats.successRate}%
                    </span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-sm">Total Scans</span>
                    <span className="text-xs font-mono">{stats.totalScans}</span>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>

      {/* New Scan Modal */}
      <NewScanModal onStartScan={startNewScan} />
    </div>
  );
};

// Helper Components
const RiskBadge: React.FC<{ risk: any }> = ({ risk }) => {
  const getRiskColor = (level: string) => {
    switch (level) {
      case 'CRITICAL': return 'badge-error';
      case 'HIGH': return 'badge-warning';
      case 'MEDIUM': return 'badge-info';
      case 'LOW': return 'badge-success';
      default: return 'badge-ghost';
    }
  };

  return (
    <div className="text-right">
      <div className={`badge ${getRiskColor(risk.risk_level)} badge-lg`}>
        {risk.risk_level}
      </div>
      <div className="text-xs text-gray-500 mt-1">
        Score: {risk.overall_score?.toFixed(1) || 'N/A'}
      </div>
    </div>
  );
};

const VulnerabilityCounts: React.FC<{ results: any }> = ({ results }) => {
  const counts = {
    web: results.web_security?.vulnerabilities?.length || 0,
    ssl: results.ssl_security?.vulnerabilities?.length || 0,
    cve: results.cve_analysis?.summary?.total_vulnerabilities || 0,
    cred: results.credential_testing?.vulnerable_credentials?.length || 0
  };

  const total = Object.values(counts).reduce((a, b) => a + b, 0);

  if (total === 0) {
    return <span className="badge badge-success badge-sm">No vulnerabilities found</span>;
  }

  return (
    <>
      {counts.web > 0 && <span className="badge badge-error badge-sm">Web: {counts.web}</span>}
      {counts.ssl > 0 && <span className="badge badge-warning badge-sm">SSL: {counts.ssl}</span>}
      {counts.cve > 0 && <span className="badge badge-info badge-sm">CVE: {counts.cve}</span>}
      {counts.cred > 0 && <span className="badge badge-secondary badge-sm">Cred: {counts.cred}</span>}
    </>
  );
};

export default VulnerabilityDashboard;